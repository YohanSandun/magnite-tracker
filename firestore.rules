rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── Block all access by default ──
    match /{document=**} {
      allow read, write: if false;
    }

    // ── Orders collection ──
    match /orders/{orderNumber} {

      // Anyone can read orders (community tracker)
      allow read: if true;

      // ── Create: validate shape & types ──
      allow create: if
        // Must contain exactly these keys
        request.resource.data.keys().hasAll([
          'orderNumber', 'model', 'color', 'orderDate',
          'smsReceivedDate', 'fullPaymentDate',
          'vehicleReceivedDate', 'vehicleNumberDate',
          'vehicleNumber', 'createdAt', 'updatedAt'
        ])
        // No extra fields allowed
        && request.resource.data.keys().size() == 11
        // Document ID must match the orderNumber field
        && request.resource.data.orderNumber == orderNumber
        // String fields
        && request.resource.data.orderNumber is string
        && request.resource.data.model is string
        && request.resource.data.color is string
        && request.resource.data.vehicleNumber is string
        // orderDate must be a timestamp
        && request.resource.data.orderDate is timestamp
        // Timestamps set by server
        && request.resource.data.createdAt == request.time
        && request.resource.data.updatedAt == request.time
        // Model must be a known variant
        && request.resource.data.model in [
          'accenta-auto', 'tekna-plus-auto',
          'n-connecta-turbo', 'tekna-plus-turbo'
        ]
        // Color must be a known value
        && request.resource.data.color in [
          'blade-silver', 'storm-white', 'pearl-white',
          'vivid-blue', 'onyx-black', 'flare-garnet-red'
        ]
        // Reasonable length limits
        && request.resource.data.orderNumber.size() >= 3
        && request.resource.data.orderNumber.size() <= 30
        && request.resource.data.vehicleNumber.size() <= 20;

      // ── Update: only allow specific milestone fields ──
      allow update: if
        // Only these fields may change
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly([
            'smsReceivedDate', 'fullPaymentDate',
            'vehicleReceivedDate', 'vehicleNumberDate',
            'vehicleNumber', 'updatedAt'
          ])
        // Core identity fields must not change
        && request.resource.data.orderNumber == resource.data.orderNumber
        && request.resource.data.model == resource.data.model
        && request.resource.data.color == resource.data.color
        && request.resource.data.orderDate == resource.data.orderDate
        && request.resource.data.createdAt == resource.data.createdAt
        // updatedAt must be server timestamp
        && request.resource.data.updatedAt == request.time
        // vehicleNumber stays a string with length limit
        && request.resource.data.vehicleNumber is string
        && request.resource.data.vehicleNumber.size() <= 20;

      // No deletes
      allow delete: if false;
    }
  }
}
